eck-operator:
  resources:
    limits:
      cpu: 1
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 150Mi
  installCRDs: true
  
  # Tolerate monitoring node
  tolerations:
    - key: "monitoring"
      operator: "Equal"
      value: "true"
      effect: "NoSchedule"
  
  # Run on monitoring node
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: monitoring
                operator: In
                values:
                  - "true"

eck-stack:
  eck-elasticsearch:
    enabled: true
    version: 8.15.0
    fullnameOverride: homelab-es
    
    annotations:
      eck.k8s.elastic.co/downward-node-labels: "topology.kubernetes.io/zone"
    
    nodeSets:
      - name: default
        count: 1
        config:
          node.store.allow_mmap: false
          node.roles: ["master", "data", "ingest", "ml", "remote_cluster_client", "transform"]
        
        podTemplate:
          spec:
            # Schedule on monitoring node
            nodeSelector:
              monitoring: "true"
            
            tolerations:
              - key: "monitoring"
                operator: "Equal"
                value: "true"
                effect: "NoSchedule"
            
            containers:
              - name: elasticsearch
                resources:
                  requests:
                    memory: 4Gi
                    cpu: 1
                  limits:
                    memory: 8Gi
                    cpu: 3
                env:
                  - name: ES_JAVA_OPTS
                    value: "-Xms2g -Xmx2g"
        
        volumeClaimTemplates:
          - metadata:
              name: elasticsearch-data
            spec:
              accessModes:
                - ReadWriteOnce
              storageClassName: local-path
              resources:
                requests:
                  storage: 50Gi

  eck-kibana:
    enabled: true
    version: 8.15.0
    fullnameOverride: homelab-kb
    
    elasticsearchRef:
      name: homelab-es
    
    podTemplate:
      spec:
        # Schedule on monitoring node
        nodeSelector:
          monitoring: "true"
        
        tolerations:
          - key: "monitoring"
            operator: "Equal"
            value: "true"
            effect: "NoSchedule"
        
        containers:
          - name: kibana
            resources:
              requests:
                memory: 1Gi
                cpu: 500m
              limits:
                memory: 2Gi
                cpu: 1
    
    http:
      service:
        spec:
          type: ClusterIP
      tls:
        selfSignedCertificate:
          disabled: false
    
    # Ingress for kibana.homelab.local
    ingress:
      enabled: true
      className: nginx  # or whatever ingress controller you use
      annotations:
        nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        nginx.ingress.kubernetes.io/ssl-passthrough: "false"
      hosts:
        - host: kibana.homelab.local
          path: /
          backend:
            service:
              name: homelab-kb-http
              port:
                number: 5601

  # Filebeat for log collection
  eck-beats:
    enabled: true
    version: 8.15.0
    fullnameOverride: homelab-filebeat
    
    serviceAccount:
      name: filebeat
    
    clusterRoleBinding:
      name: filebeat-autodiscover-binding
      subjects:
        - kind: ServiceAccount
          name: filebeat
          namespace: elastic-stack
      roleRef:
        kind: ClusterRole
        name: filebeat-autodiscover
        apiGroup: rbac.authorization.k8s.io
    
    clusterRole:
      name: filebeat-autodiscover
      rules:
        - apiGroups: [""]
          resources:
            - nodes
            - namespaces
            - events
            - pods
          verbs:
            - get
            - list
            - watch
        - apiGroups: ["apps"]
          resources:
            - replicasets
          verbs:
            - get
            - list
            - watch
        - apiGroups: ["batch"]
          resources:
            - jobs
          verbs:
            - get
            - list
            - watch
    
    spec:
      type: filebeat
      elasticsearchRef:
        name: homelab-es
      kibanaRef:
        name: homelab-kb
      
      config:
        filebeat.autodiscover:
          providers:
            - type: kubernetes
              node: ${NODE_NAME}
              hints.enabled: true
              hints.default_config:
                type: container
                paths:
                  - /var/log/containers/*-${data.kubernetes.container.id}.log
        
        processors:
          - add_cloud_metadata: {}
          - add_host_metadata: {}
      
      daemonSet:
        podTemplate:
          spec:
            serviceAccountName: filebeat
            automountServiceAccountToken: true
            terminationGracePeriodSeconds: 30
            dnsPolicy: ClusterFirstWithHostNet
            hostNetwork: true
            
            # Filebeat runs on ALL nodes (no nodeSelector)
            tolerations:
              - key: "monitoring"
                operator: "Equal"
                value: "true"
                effect: "NoSchedule"
            
            containers:
              - name: filebeat
                securityContext:
                  runAsUser: 0
                volumeMounts:
                  - name: varlogcontainers
                    mountPath: /var/log/containers
                    readOnly: true
                  - name: varlogpods
                    mountPath: /var/log/pods
                    readOnly: true
                  - name: varlibdockercontainers
                    mountPath: /var/lib/docker/containers
                    readOnly: true
                env:
                  - name: NODE_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: spec.nodeName
                resources:
                  requests:
                    memory: 200Mi
                    cpu: 100m
                  limits:
                    memory: 400Mi
                    cpu: 200m
            
            volumes:
              - name: varlogcontainers
                hostPath:
                  path: /var/log/containers
              - name: varlogpods
                hostPath:
                  path: /var/log/pods
              - name: varlibdockercontainers
                hostPath:
                  path: /var/lib/docker/containers